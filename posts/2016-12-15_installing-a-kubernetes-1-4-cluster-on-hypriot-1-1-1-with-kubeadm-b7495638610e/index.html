<!doctype html><html lang=en-us><head><meta charset=utf-8><title>kubecloud</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="It’s been a while since our last blog post. However, we are back and again working with Kubernetes on a daily basis. This blog post will…"><meta name=author content="kubecloud.io"><meta name=generator content="Hugo 0.62.2"><link rel=stylesheet href=plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=plugins/themify-icons/themify-icons.css><link rel=stylesheet href=/scss/style.min.e92287ba30e877e203e37f813150a9226378acce473f0a198f39c3a0294241b4.css integrity="sha256-6SKHujDod+ID43+BMVCpImN4rM5HPwoZjznDoClCQbQ=" media=screen><link rel="shortcut icon" href=images/favicon.png type=image/x-icon><link rel=icon href=images/favicon.png type=image/x-icon></head><body><div class=preloader></div><header class=navigation><div class="col-md-10 offset-md-1"><nav class="navbar navbar-expand-lg navbar-white bg-transparent"><a class="navbar-brand mobile-view" href><img class=img-fluid src=images/kubecloud.png alt=kubecloud></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><a class="navbar-brand desktop-view" href><img class=img-fluid src=images/kubecloud.png alt=kubecloud></a><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href>Home</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Blog</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=/blog>All</a><div class=dropdown-divider></div><a class=dropdown-item href=/categories/conference>Conference</a>
<a class=dropdown-item href=/categories/kops>Kops</a>
<a class=dropdown-item href=/categories/raspberry-pi>Raspberry pi</a>
<a class=dropdown-item href=/categories/thesis>Thesis</a></div></li><li class=nav-item><a class=nav-link href=about>About</a></li></ul><div class="search px-4"><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=/search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder="Type & Hit Enter..."></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><section class=section-sm><div class=container><div class=row><div class="col-lg-10 mx-auto"><a href=/categories/raspberry-pi class=text-primary>Raspberry pi</a><h1>Installing a Kubernetes 1.4 cluster on Hypriot 1.1.1 with kubeadm</h1><div class="mb-3 post-meta"><span>By Kasper Nissen,</span>
<span>15 December 2016</span></div><img src=/images/1__ipFQkJrHHyzT2i82LaVLyQ.jpeg class="img-fluid w-100 mb-4" alt="Installing a Kubernetes 1.4 cluster on Hypriot 1.1.1 with kubeadm"><div class="content mb-5"><p><img src=/images/1__ipFQkJrHHyzT2i82LaVLyQ.jpeg alt></p><p>It’s been a while since our last blog post. However, we are back and again working with Kubernetes on a daily basis. This blog post will show you how to set up a Kubernetes 1.4 cluster with HypriotOS 1.1.1 and the new <code>kubeadm</code> tool.</p><h3 id=prerequisites>Prerequisites</h3><ul><li>A couple of Raspberry Pis (minimum two)</li><li>A switch to connect the Raspberry Pis</li><li>Cables for power and network</li></ul><p>For this tutorial we used 4 Raspberry Pi 3 and a Macbook Pro.</p><h3 id=flashing-thesd-cards>Flashing the SD-cards</h3><p>First, flash the SD cards with <a href=https://github.com/hypriot/image-builder-rpi/releases/download/v1.1.1/hypriotos-rpi-v1.1.1./images.zip>HypriotOS 1.1.1</a> using the Hypriot <a href=https://github.com/hypriot/flash>flash tool</a>.</p><pre><code>$ flash --hostname master hypriotos-rpi-v1.1.1./images.zip $ flash --hostname slave01 hypriotos-rpi-v1.1.1./images.zip $ flash --hostname slave02 hypriotos-rpi-v1.1.1./images.zip $ flash --hostname slave03 hypriotos-rpi-v1.1.1./images.zip
</code></pre><p>When the flash of the 4 sd-cards has completed, insert them into the 4 Raspberry Pis and power them up. Make sure you are able to contact the Pis by SSH’ing into them one by one. The default password for the pirate-user is: <em>hypriot</em></p><pre><code>$ ssh pirate@master.local $ ssh pirate@slave01.local $ ssh pirate@slave02.local $ ssh pirate@slave03.local
</code></pre><p>After logging into the Pis, <code>exit</code> back to your machine.</p><p>Next, we need to set up our SSH-keys:</p><pre><code>ssh-add ssh-keygen -R master.local ssh-copy-id pirate@master.local
</code></pre><p>Repeat the above for all the Pis.</p><h3 id=configuring-theips>Configuring the IPs</h3><p>To make things easier to handle, I want to change the IPs to static IPs. I chose the IP scheme to be:</p><pre><code>192.168.1.100 (master) 192.168.1.101 (slave01) 192.168.1.102 (slave02) 192.168.1.103 (slave03)
</code></pre><p><strong>Repeat for all Pis</strong></p><p>First SSH into the Pi</p><pre><code>$ ssh pirate@master.local $ sudo nano /etc/network/interfaces
</code></pre><p>Replace the content of this file with</p><pre><code>auto lo iface lo inet loopback 
</code></pre><pre><code>allow-hotplug eth0ifaceeth0 inet static address **&lt;YOUR IP GOES HERE&gt;** netmask 255.255.255.0 network 192.168.1.0 broadcast 192.168.1.255 gateway 192.168.1.1 dns-nameservers 192.168.1.1 8.8.8.8 8.8.4.4 
</code></pre><pre><code>iface eth0 inet6 auto 
</code></pre><pre><code>allow-hotplug wlan0 iface wlan0 inet dhcp pre-up /usr/bin/occi wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf iface default inet dhcp
</code></pre><p>Then reboot each device by running</p><pre><code>sudo reboot
</code></pre><h3 id=installing-kubernetes>Installing Kubernetes</h3><p>Switch to the root user</p><pre><code>sudo -s
</code></pre><p>And execute the following, which will add the Kubernetes apt-get respository to the resources.</p><pre><code>$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - $ cat &lt;&lt;EOF &gt; /etc/apt/sources.list.d/kubernetes.list deb http://apt.kubernetes.io/ kubernetes-xenial main EOF
</code></pre><p><strong>Notice: Make sure there isn’t a space after <em>EOF</em>.</strong></p><p>Update everything</p><pre><code>$ apt-get update
</code></pre><p>Then install the <code>kubelet</code>, <code>kubeadm</code>, <code>kubectl</code>, and <code>kubernetes-cni</code></p><pre><code>$ apt-get install -y kubelet kubeadm kubectl kubernetes-cni
</code></pre><h3 id=setting-up-themaster>Setting up the master</h3><pre><code>kubeadm init --pod-network-cidr=10.244.0.0/16
</code></pre><p>The <code>--pod-network-cidr=10.244.0.0/16</code> is needed for flannel to be configured correctly. Flannel is at the moment the only overlay network that works with Raspberry Pis. When the command has finished, (which will take a couple of minues) the output will be similar to the following:</p><pre><code>Public: /etc/kubernetes/pki/ca-pub.pem Private: /etc/kubernetes/pki/ca-key.pem Cert: /etc/kubernetes/pki/ca.pem &lt;master/pki&gt; generated API Server key and certificate: Issuer: CN=kubernetes | Subject: CN=kube-apiserver | CA: false Not before: 2016-11-24 20:25:58 +0000 UTC Not After: 2017-11-24 20:26:02 +0000 UTC Alternate Names: [192.168.1.100 10.96.0.1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] Public: /etc/kubernetes/pki/apiserver-pub.pem Private: /etc/kubernetes/pki/apiserver-key.pem Cert: /etc/kubernetes/pki/apiserver.pem &lt;master/pki&gt; generated Service Account Signing keys: Public: /etc/kubernetes/pki/sa-pub.pem Private: /etc/kubernetes/pki/sa-key.pem &lt;master/pki&gt; created keys and certificates in &quot;/etc/kubernetes/pki&quot; &lt;util/kubeconfig&gt; created &quot;/etc/kubernetes/kubelet.conf&quot; &lt;util/kubeconfig&gt; created &quot;/etc/kubernetes/admin.conf&quot; &lt;master/apiclient&gt; created API client configuration &lt;master/apiclient&gt; created API client, waiting for the control plane to become ready &lt;master/apiclient&gt; all control plane components are healthy after 188.931005 seconds &lt;master/apiclient&gt; waiting for at least one node to register and become ready &lt;master/apiclient&gt; first node is ready after 5.533117 seconds &lt;master/apiclient&gt; attempting a test deployment &lt;master/apiclient&gt; test deployment succeeded &lt;master/discovery&gt; created essential addon: kube-discovery, waiting for it to become ready &lt;master/discovery&gt; kube-discovery is ready after 185.528275 seconds &lt;master/addons&gt; created essential addon: kube-proxy &lt;master/addons&gt; created essential addon: kube-dns Kubernetes master initialised successfully! You can now join any number of machines by running the following on each node: kubeadm join --token=c3625d6ebda8defc 192.168.1.100
</code></pre><p>Should anything fail during the setup, run <code>kubeadm reset</code>, then <code>systemctl start kubelet.service</code>, and try again.</p><p>Next, we need to install the cluster network, which as mentioned earlier will be flannel.</p><pre><code>$ export ARCH=arm $ curl -sSL &quot;https://github.com/coreos/flannel/blob/master/Documentation/kube-flannel.yml?raw=true&quot; | sed &quot;s/amd64/${ARCH}/g&quot; | kubectl create -f -
</code></pre><p>Verify that the kube-dns pod is running: <code>kubectl get pods --all-namespaces</code></p><h3 id=setting-up-the-slavesworkers>Setting up the slaves/workers</h3><p>Copy the command from the output of the master setup and run it on all your workers.</p><pre><code>kubeadm join --token &lt;token&gt; &lt;master-ip&gt;
</code></pre><p>After a couple of minutes, your Raspberry Pi Kubernetes cluster is ready. Verify with <code>kubectl get nodes</code> on the master pi. The output should be similar to this:</p><pre><code>NAME STATUS AGE master Ready 13m slave01 Ready 1m slave02 Ready 51s slave03 Ready 30s
</code></pre><h3 id=getting-access-to-your-cluster-from-you-ownmachine>Getting access to your cluster from you own machine</h3><p>Make sure you have <code>kubectl</code> installed. Then SSH into the master and open the following file:</p><pre><code>$ ssh pirate@master.local $ sudo cat /etc/kubernetes/admin.conf
</code></pre><p>Copy the content of this file to a place on your own machine. I just copy/pasted it in to a file called <code>raspberrypi.conf</code>.</p><p>Now, from your local machine you can access the cluster as follows:</p><pre><code>$ kubectl --kubeconfig raspberrypi.conf get nodes
</code></pre><p>Now your Kubernetes cluster is ready to be used! Awesome! :)</p><p><em>Originally published at</em> <a href=http://kubecloud.io/kubernetes-cluster-with-kubeadm/><em>kubecloud.io</em></a> <em>on December 15, 2016.</em></p></div></div></div></div></section><footer><div class="col-md-10 offset-md-1"><div class=row><div class="col-lg-3 col-sm-6 mb-5"><a href><img class=img-fluid src=images/kubecloud.png alt=kubecloud></a></div><div class="col-lg-3 col-sm-6 mb-5"></div><div class="col-lg-3 col-sm-6 mb-5"></div><div class="col-lg-3 col-sm-6 mb-5 text-right"><h6 class=mb-4>Quick Links</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=blog>Blog</a></li><li class=mb-3><a class=text-dark href=about/about>About</a></li></ul></div><div class="col-6 py-4 text-left social border-top"><ul><li><a class=social-link href=https://twitter.com/phennex><i class=ti-twitter-alt></i></a></li><li><a class=social-link href=https://twitter.com/mrjensens><i class=ti-twitter-alt></i></a></li><li><a class=social-link href=https://github.com/kubecloud><i class=ti-github></i></a></li></ul></div><div class="col-6 py-4 text-right border-top">@2020 <a href=https://kubecloud.io>kubecloid.io</a> All Rights Reserved</div></div></div></footer><script>var indexURL="index.json"</script><script src=plugins/jQuery/jquery.min.js></script><script src=plugins/bootstrap/bootstrap.min.js></script><script src=plugins/search/fuse.min.js></script><script src=plugins/search/mark.js></script><script src=plugins/search/search.js></script><script src=/js/script.min.js></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','Your ID','auto');ga('send','pageview');</script></body></html>