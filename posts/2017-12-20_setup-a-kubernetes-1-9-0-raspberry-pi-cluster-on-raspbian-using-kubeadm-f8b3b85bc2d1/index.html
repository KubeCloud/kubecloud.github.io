<!doctype html><html lang=en-us><head><meta charset=utf-8><title>kubecloud</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Apparently it’s that time of the year again. Approximately a year ago I published a “state-of-the-art” how to run a Raspberry Pi Kubernetes…"><meta name=author content="kubecloud.io"><meta name=generator content="Hugo 0.62.2"><link rel=stylesheet href=https://kubecloud.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://kubecloud.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://kubecloud.io/scss/style.min.e92287ba30e877e203e37f813150a9226378acce473f0a198f39c3a0294241b4.css integrity="sha256-6SKHujDod+ID43+BMVCpImN4rM5HPwoZjznDoClCQbQ=" media=screen><link rel="shortcut icon" href=https://kubecloud.io/images/favicon.png type=image/x-icon><link rel=icon href=https://kubecloud.io/images/favicon.png type=image/x-icon></head><body><div class=preloader></div><header class=navigation><div class="col-md-10 offset-md-1"><nav class="navbar navbar-expand-lg navbar-white bg-transparent"><a class="navbar-brand mobile-view" href=https://kubecloud.io><img class=img-fluid src=https://kubecloud.io/images/kubecloud.png alt=kubecloud></a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h3"></i></button><div class="collapse navbar-collapse text-center" id=navigation><a class="navbar-brand desktop-view" href=https://kubecloud.io><img class=img-fluid src=https://kubecloud.io/images/kubecloud.png alt=kubecloud></a><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://kubecloud.io>Home</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Blog</a><div class=dropdown-menu aria-labelledby=navbarDropdown><a class=dropdown-item href=https://kubecloud.io/blog>All</a><div class=dropdown-divider></div><a class=dropdown-item href=https://kubecloud.io/categories/conference>Conference</a>
<a class=dropdown-item href=https://kubecloud.io/categories/kops>Kops</a>
<a class=dropdown-item href=https://kubecloud.io/categories/raspberry-pi>Raspberry pi</a>
<a class=dropdown-item href=https://kubecloud.io/categories/thesis>Thesis</a></div></li><li class=nav-item><a class=nav-link href=https://kubecloud.io/about>About</a></li></ul><div class="search px-4"><button id=searchOpen class=search-btn><i class=ti-search></i></button><div class=search-wrapper><form action=https://kubecloud.io/search class=h-100><input class="search-box px-4" id=search-query name=s type=search placeholder="Type & Hit Enter..."></form><button id=searchClose class=search-close><i class="ti-close text-dark"></i></button></div></div></div></nav></div></header><section class=section-sm><div class=container><div class=row><div class="col-lg-10 mx-auto"><a href=https://kubecloud.io/categories/raspberry-pi class=text-primary>Raspberry pi</a><h1>Setup a Kubernetes 1.9.0 Raspberry Pi cluster on Raspbian using Kubeadm</h1><div class="mb-3 post-meta"><span>By Kasper Nissen,</span>
<span>20 December 2017</span></div><img src=https://kubecloud.io/images/0__GPcn3MHgE5zbLhVa.jpg class="img-fluid w-100 mb-4" alt="Setup a Kubernetes 1.9.0 Raspberry Pi cluster on Raspbian using Kubeadm"><div class="content mb-5"><p><img src=https://kubecloud.io/images/0__GPcn3MHgE5zbLhVa.jpg alt=Image></p><p>Apparently it’s that time of the year again. Approximately a year ago I published a “state-of-the-art” how to run a Raspberry Pi Kubernetes cluster using HypriotOS and Kubernetes 1.4. Lots of things has happen during the past year, and I thought it was time to play with the Raspberry Pi cluster again. This blog post will guide you through the process of setting up a Raspberry Pi Kubernetes cluster on the <a href=https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2017-12-01/>latest version of Raspbian</a>, and with the latest version of Kubernetes, which is 1.9.0.</p><p>This blog post was inspired by the <a href=https://gist.github.com/alexellis/fdbc90de7691a1b9edb545c17da2d975>great work</a> of Docker Captain Alex Ellis.</p><p>Let’s get started!</p><h3 id=initial-setup-of-sd-cards-and-prerequisites>Initial setup of SD-cards and prerequisites</h3><p>The following section is pretty generic. This flow has to be repeated for every node you want to join your cluster.</p><h4 id=flashing-the-sdcard>Flashing the SD card</h4><p>The first thing we need is an image. Grab the <a href=https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2017-12-01/>latest Raspbian OS here</a> (.zip). <br>I use <a href=https://etcher.io/>etcher</a> by Resin.io for flashing the SD-cards. It doesn’t get easier than this.</p><p>Just select the .zip file you just downloaded, and insert your SD-card, select the drive, and click “Flash!”. Easy, right?</p><p><img src=https://kubecloud.io/images/1__ZBLNmxntiu8RG3ZAOSya__A.png alt="This is an image"></p><p>Once the flashing process is finished, we need to add an empty file to the drive. Therefore, take the SD-card out and insert it again. We are going to create an empty file called ssh. This allow us to SSH into the node once booted.</p><pre><code>$ touch /Volumes/boot/ssh
</code></pre><p>Now, take out the SD-card and insert it into the Raspberry Pi. Attach network cable and power, and boot up the little machine.</p><p>After a minute or so, you should be able to access the Raspberry Pi from the same network.</p><pre><code>$ ssh pi@raspberrypi.local
</code></pre><p>Default raspbian password is: <em>raspberry</em></p><h4 id=change-the-hostname-and-assign-a-staticip>Change the hostname and assign a static IP</h4><p>Next, we will configure the Raspberry Pi, so that it’s easy to identify and access. We will therefore change the hostname, and assign a static IP to the node. In order to make this process a bit easier, I have made a simple script for you.</p><p>In order to run it, create a new file on the Pi:</p><pre><code>$ nano hostname\_and\_ip.sh
</code></pre><p>Copy the following into the new file</p><p>And run the script (below is the naming and IP convention used in my setup, you should adapt this to your network setup)</p><p>First argument: the new hostname<br>Second argument: the new static IP<br>Third argument: the IP of your Router</p><p><strong><em>master: 192.168.1.100</em></strong></p><pre><code>$ sh hostname\_and\_ip.sh master 192.168.1.100 192.168.1.1
</code></pre><p><strong><em>worker-01: 192.168.1.101</em></strong></p><pre><code>$ sh hostname\_and\_ip.sh worker-01 192.168.1.101 192.168.1.1
</code></pre><p><strong><em>worker-02: 192.168.1.102</em></strong></p><pre><code>$ sh hostname\_and\_ip.sh worker-02 192.168.1.102 192.168.1.1
</code></pre><p><strong><em>worker-03: 192.168.1.103</em></strong></p><pre><code>$ sh hostname\_and\_ip.sh worker-03 192.168.1.103 192.168.1.1
</code></pre><p>Now, reboot the Pi. You should be able to access the Pi over SSH as follows:</p><pre><code>$ ssh pi@master.local (or worker-01.local etc.) 
</code></pre><p>Verify that your Pi now also has a new static ip by running <em>ifconfig</em>.</p><h4 id=installing-the-prerequisites>Installing the prerequisites</h4><p>Now, that node networking and naming is in place, we need to install some software on the Raspberry Pi. First of all we need docker, secondly we need to add the kubernetes repo to the repo list, disable swap memory, and lastly install kubeadm. Again, in order to make this process easy for you as a reader, all of this can be run as a script.</p><p>Therefore, create a new file on the Raspberry Pi:</p><pre><code>$ nano init.sh
</code></pre><p>Copy and insert the following script.</p><p><em>I experienced some issues with a change in the kernel related to cgroups_memory. The current solution is reflected in the script above. However, if you encounter issues, you might want to change cgroup_memory=1 to cgroup_enable=memory. For now, however, cgroup_memory=1 is working. More on this can be found</em> <a href=https://github.com/raspberrypi/linux/commit/ba742b52e5099b3ed964e78f227dc96460b5cdc0><em>here</em></a><em>.</em></p><p>Run the script,</p><pre><code>$ sh init.sh
</code></pre><p>Reboot the machine and SSH back into the Raspberry Pi once the reboot has finished.</p><pre><code>$ sudo reboot
</code></pre><p>That was all the prerequisites and generic setup of all the Raspberry Pis. Remember to repeat this process for every node in the cluster.</p><p>Now, let’s move on to setting up our Kubernetes master.</p><h3 id=initialize-the-kubernetes-master>Initialize the Kubernetes master</h3><p>So, we are now ready to set up Kubernetes. To do this, we are going to use the awesome tool called, kubeadm. This makes it pretty easier to spin up a Kubernetes cluster by, basically, running <em>kubeadm init</em> on the master node and <em>kubeadm join</em> on the worker nodes.</p><p>One of the purposes of this cluster is going to be demoing Kubernetes stuff. One example could be to pull out the network cable of one of the worker nodes and demoing how Kubernetes deals with this situation by rescheduling the pods from the lost node.</p><p>Therefore, we would like to change one of the arguments to the kube-controller-manager, namely, pod-eviction-timeout which defaults to 5 minutes. That’s a long time to wait in a presentation. Instead, we want to change this to 10s.</p><p>Changing arguments passed to the different Kubernetes core components by kubeadm is pretty simple. We just have to pass a YAML configuration file specifying the arguments we want to change. Let’s do that.</p><p>Create the configuration file:</p><pre><code>$ nano kubeadm\_conf.yaml
</code></pre><p>Copy and insert the following</p><pre><code>apiVersion: kubeadm.k8s.io/v1alpha1kind: MasterConfiguration
</code></pre><p>You may wish to change the time that Kubernetes allows the node to be unresponsive as well. It defaults to 40 seconds. To change this, add the following argument to the master configuration above: <code>node-monitor-grace-period: 10s.</code></p><p>Save and run</p><pre><code>$ sudo kubeadm init --config kubeadm\_conf.yaml
</code></pre><p>This takes a couple of minutes. Once the process finishes you should see something similar to:</p><pre><code>...

Your Kubernetes master has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube  
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><p>You should now deploy a pod network to the cluster.<br>Run <code>kubectl apply -f \[podnetwork\].yaml</code> with one of the options listed at:<br><a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/>https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p><p>You can now join any number of machines by running the following on each node<br>as root:</p><pre><code>kubeadm join --token TOKEN 192.168.1.100:6443 --discovery-token-ca-cert-hash HASH
</code></pre><p>Follow the instructions in the output:</p><p>$ mkdir -p $HOME/.kube<br>$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>$ sudo chown $(id -u):$(id -g) $HOME/.kube/config</p><p>You can verify that your master node is up and running.</p><p>pi@master:~ $ kubectl get nodes<br>NAME STATUS ROLES AGE VERSION<br>master NotReady master 3m v1.9.0</p><p>Don’t mind the status being NotReady. In order for the master node to become ready we need to install a container network. But before we do that, let’s add some more nodes to the cluster first.</p><h3 id=setting-up-the-workernodes>Setting up the worker nodes</h3><p>Alright, next up we need to spin up some workers for the cluster to be complete.</p><p>Assuming you have already set up the prerequisuites mentioned above, we basically only need to run the kubeadm join on each of your worker nodes. As shown above, kubeadm outputs the command that you need to run on all your worker nodes.</p><p>$ sudo kubeadm join &ndash;token TOKEN 192.168.1.100:6443 &ndash;discovery-token-ca-cert-hash HASH</p><p>Repeat for every node.</p><h3 id=set-up-the-container-network>Set up the container network</h3><p>Nodes are not able to communicate without a container network, which is something you have to provide. Therefore, the final piece of the puzzle is to add one. We will be using weave-net for this. On the master node, run the following command:</p><p>$ <code>kubectl apply -f https://git.io/weave-kube-1.6</code></p><h3 id=all-set-anddone>All set and done…</h3><p>That was it. You should now have a fully functioning Raspberry Pi Kubernetes cluster. Verify your setup by running</p><p>pi@master:~ $ kubectl get nodes<br>NAME STATUS ROLES AGE VERSION<br>master Ready master 55m v1.9.0<br>worker-01 Ready 34m v1.9.0<br>worker-02 Ready 14m v1.9.0<br>worker-03 Ready 5m v1.9.0</p><p>Last thing we need to verify is that the configuration of the controller-manager we specified earlier. Did the pod-eviction-timeout get parsed to the actual kube-controller-manager process? This is easy to test, just run</p><p>$ kubectl describe pod kube-controller-manager-master -n kube-system</p><p>You should see something similar to this</p><p>&mldr;<br>&mldr;<br>Containers:<br>kube-controller-manager:<br>Container ID: docker://f9f4077d9008690f04169932c02fba79c8d446b71a347f75c2f6aa96f36587ca<br>Image: gcr.io/google_containers/kube-controller-manager-arm:v1.9.0<br>Image ID: docker-pullable://gcr.io/google_containers/kube-controller-manager-arm@sha256:167a5468244114c484856bfe995cc3630678f0ab2aa85cf9d1ab6341fd04b8e5<br>Port:<br>Command:<br>kube-controller-manager<br><strong>--pod-eviction-timeout=10s</strong><br>&ndash;kubeconfig=/etc/kubernetes/controller-manager.conf<br>&ndash;service-account-private-key-file=/etc/kubernetes/pki/sa.key<br>&ndash;cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt<br>&ndash;cluster-signing-key-file=/etc/kubernetes/pki/ca.key<br>&ndash;address=127.0.0.1<br>&ndash;leader-elect=true<br>&ndash;use-service-account-credentials=true<br>&ndash;controllers=*,bootstrapsigner,tokencleaner<br>&ndash;root-ca-file=/etc/kubernetes/pki/ca.crt<br>State: Running<br>Started: Wed, 20 Dec 2017 18:52:13 +0000<br>Ready: True<br>Restart Count: 0<br>&mldr;<br>&mldr;</p><p>As you can see the parameter was passed correctly to the kube-controller-manager.</p><p><img src=https://kubecloud.io/images/1__31D9YBkzJzv5vx36PsZLQg.jpeg alt></p><p>That was all for this time folks. Happy hacking.</p></div></div></div></div></section><footer><div class="col-md-10 offset-md-1"><div class=row><div class="col-lg-3 col-sm-6 mb-5"><a href=https://kubecloud.io><img class=img-fluid src=https://kubecloud.io/images/kubecloud.png alt=kubecloud></a></div><div class="col-lg-3 col-sm-6 mb-5"></div><div class="col-lg-3 col-sm-6 mb-5"></div><div class="col-lg-3 col-sm-6 mb-5 text-right"><h6 class=mb-4>Quick Links</h6><ul class=list-unstyled><li class=mb-3><a class=text-dark href=https://kubecloud.io/blog>Blog</a></li><li class=mb-3><a class=text-dark href=https://kubecloud.io/about/about>About</a></li></ul></div><div class="col-6 py-4 text-left social border-top"><ul><li><a class=social-link href=https://twitter.com/phennex><i class=ti-twitter-alt></i></a></li><li><a class=social-link href=https://twitter.com/mrjensens><i class=ti-twitter-alt></i></a></li><li><a class=social-link href=https://github.com/kubecloud><i class=ti-github></i></a></li></ul></div><div class="col-6 py-4 text-right border-top">@2020 <a href=https://kubecloud.io>kubecloid.io</a> All Rights Reserved</div></div></div></footer><script>var indexURL="https://kubecloud.io/index.json"</script><script src=https://kubecloud.io/plugins/jQuery/jquery.min.js></script><script src=https://kubecloud.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://kubecloud.io/plugins/search/fuse.min.js></script><script src=https://kubecloud.io/plugins/search/mark.js></script><script src=https://kubecloud.io/plugins/search/search.js></script><script src=https://kubecloud.io/js/script.min.js></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','Your ID','auto');ga('send','pageview');</script></body></html>